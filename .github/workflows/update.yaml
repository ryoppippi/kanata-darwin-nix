name: update-sources
on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  update-sources:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - run: ./update.ts
      - run: "git config user.email 41898282+github-actions[bot]@users.noreply.github.com"
      - run: "git config user.name github-actions[bot]"
      - run: "git add -A"
      - name: Commit with versions
        run: |
          if ! git diff --staged --quiet; then
            KANATA_VERSION=$(jq -r '.version' packages/kanata/sources.json)
            VK_AGENT_VERSION=$(jq -r '.version' packages/kanata-vk-agent/sources.json)
            DRIVERKIT_VERSION=$(jq -r '.version' packages/karabiner-driverkit/sources.json)
            git commit -m "chore: update packages (kanata $KANATA_VERSION, vk-agent $VK_AGENT_VERSION, driverkit $DRIVERKIT_VERSION)"
          fi
      - run: "git push -u origin main"
